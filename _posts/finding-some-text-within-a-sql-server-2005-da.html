title: Finding some text within a SQL Server 2005 Database
date: 2008/01/24 12:59:00 -0800
tags: [{"name":"download","id":3772771},{"name":"SQLServer","id":58676598}]
author: Jane Dallaway
alias: /finding-some-text-within-a-sql-server-2005-da

<p>I was asked what sounded like a fairly simple question today - is there a way to do a full text search of a database, without having to set up full text searching.  As this was to answer an immediate query - where was some text that was being displayed coming from - and not within the context of a query to form part of an application I thought about it a while, and decided that some dynamic  SQL was what was needed.  I started off with the fact that I wanted to pull together a statement like:<br /><span class="code">SELECT COUNT(*) FROM TableName WHERE ColumnName LIKE '%SearchTerm%'</span><br />and then run that across all columns which are text, ntext, varchar, nvarchar, char or nchar.<p />Getting the list of table and column names is reasonably straightforward<br /><span class="code">SELECT TABLE_NAME,COLUMN_NAME<br />FROM INFORMATION_SCHEMA.COLUMNS<br />WHERE DATA_TYPE IN ('varchar', 'nvarchar', 'text', 'ntext', 'char', 'nchar')</span><p />I wanted to loop through all of these and get the counts, so I used a local table variable to hold the results<br /><span class="code">DECLARE @tabSearchableColumns TABLE (TableName VARCHAR(100), ColumnName VARCHAR(100), Matches int)</span> and simply inserted the results of the above query into it (along with a NULL for the Matches column).  I then set up a loop, looping based on the <span class="code">COUNT(*) FROM @tabSearchableColumns WHERE Matches IS NULL</span>. Within that loop I take the top item from @tabSearchableColumns, and use the TableName and ColumnName to populate the SQL SELECT above.  <p />Now came the interesting part, getting the variable <span class="code">@intDataCount</span> from the following statement:<br /><span class="code">EXEC (SELECT @intDataCount = COUNT(*) FROM TableName WHERE ColumnName LIKE '%SearchTerm%)</span><br />as the variable @intDataCount has the scope of the execute statement, and doesn't get propogated to any outside variable with the same name.<p />To get around this involves the use of <a href="http://msdn2.microsoft.com/en-us/library/ms175170.aspx">sp_executesql</a> specifying the parameter that we expect to get out, i.e. <span class="code">EXEC sp_executesql @strSQL, N'@intDataCount INT OUTPUT', @intDataCount OUTPUT</span><p />An important point here is that @strSQL, or the string being sent in as the SQL string MUST be cast be an <span class="code">NVARCHAR</span>, either by <span class="code">DECLARE @strSQL NVARCHAR(100)</span> or <span class="code">N'SELECT ColumnName FROM TableName'</span>.  Otherwise, don't be surprised to encounter the following error:<br /><span class="code">Msg 214, Level 16, State 2, Procedure sp_executesql, Line 1<br />Procedure expects parameter '@statement' of type 'ntext/nchar/nvarchar'.</span><p />Finally, having got the count out into my @intDataCount variable, I can update the appropriate row in tabSearchableColumns, redo the <span class="code">COUNT(*) FROM @tabSearchableColumns WHERE Matches IS NULL</span> and continue looping.  The final stage is just to select the table and column data which has Matches &gt; 0.<p />The script for <a href="https://github.com/janedallaway/SQL-Server-Helper-Scripts/blob/master/FindTableColumnDataMatches.sql">FindTableColumnDataMatches</a> is available for <a href="https://github.com/janedallaway/SQL-Server-Helper-Scripts/blob/master/FindTableColumnDataMatches.sql">download</a>, and as with <a href="https://github.com/janedallaway/SQL-Server-Helper-Scripts/blob/master/spu_generateInsert.sql">sp_generateinsert</a> is tested against SQL Server 2005, leave me comments if you've found this useful, or have suggestions for improvements.</p>
