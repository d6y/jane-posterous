title: SSIS Foreach Nodelist enumerators Part 2
date: 2006/08/14 08:47:00 -0700
tags: [{"name":"SQLServer","id":58673803}]
author: Jane Dallaway
alias: /ssis-foreach-nodelist-enumerators-part-2

<p>My euphoria at getting my <a href="http://jane.dallaway.com/ssis-foreach-nodelist-enumerators">SSIS Foreach Nodelist enumerators</a> working was short lived.  I had some really strange behaviour going on with my foreach nodelist.  It appeared that the XML being interpreted by the node wasn't the XML being passed in.  I am using the method described in the <a href="http://sqlug.be/blogs/drivenbysql/archive/2006/07/27/258.aspx">DrivenBySQL</a> example, using a node and putting the node contents into an object variable objNode.  This objNode is then broken into its composite elements in some script (as described <a href="http://jane.dallaway.com/ssis-foreach-nodelist-enumerators">the other day</a>).  Those composite elements are then processed.  What was happening was that the processing was doing the data for this iteration, but also every other iteration.  I wanted to prove that this was really happening, and I wasn't just having a funny five minutes.  So I started a new project and created some standard Direct Input XML, one for images and one for some random data.<p /><strong>Images XML - outer loop</strong><p /><span class="code">&lt;images&gt;<br />&nbsp;&nbsp;&lt;image&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&lt;source&gt;8162_5260.JPG&lt;/source&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&lt;destination&gt;87775588_01.JPG&lt;/destination&gt;<br />&nbsp;&nbsp;&lt;/image&gt;<br />&nbsp;&nbsp;&lt;image&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&lt;source&gt;8162_5260_01.JPG&lt;/source&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&lt;destination&gt;87775588_02.JPG&lt;/destination&gt;<br />&nbsp;&nbsp;&lt;/image&gt;<br />&lt;/images&gt;</span><p /><strong>Data XML - Inner loop</strong><p /><span class="code">&lt;ROOT&gt;<br />&nbsp;&nbsp;&lt;Item&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&lt;Data&gt;Entry&lt;/Data&gt;<br />&nbsp;&nbsp;&lt;/Item&gt;<br />&lt;/ROOT&gt;</span><p />I've used a string variable to put comments of what is going on in.  So, it puts a started tag and a date time stamp in. <br />I loop through the image nodes in the outer loop - which should result in two iterations.<br />Within the outer loop<br />&nbsp;&nbsp;I add a log entry to the string with the Source entity data in.<br />&nbsp;&nbsp;I then loop through the Item nodes in the inner loop - which should result in one iteration.<br />&nbsp;&nbsp;Within the inner loop <br />&nbsp;&nbsp;&nbsp;&nbsp;I add a log entry with the datetime stamp and the Data entity.<br />&nbsp;&nbsp;Inner loop ends<br />Outer loop ends<p /><strong>Expected Output</strong><p />Started at 11/08/2006 12:05:11<br />Image 8162_5260.JPG<br />For each logged at 11/08/2006 12:05:11 with data of Entry<br />Image 8162_5260_01.JPG<br />For each logged at 11/08/2006 12:05:12 with data of Entry<br />Completed at 11/08/2006 12:05:12<p />so with 1 For each line per iteration, but what I actually get is:<p /><strong>Output</strong><p />Started at 11/08/2006 12:05:11 <br />Image 8162_5260.JPG<br />For each logged at 11/08/2006 12:05:11 with data of Entry<br />Image 8162_5260_01.JPG<br />For each logged at 11/08/2006 12:05:11 with data of Entry<br />For each logged at 11/08/2006 12:05:12 with data of Entry<br />Completed at 11/08/2006 12:05:12<p />which implies that the data being returned in the inner foreach contains data from both the 1st and 2nd iterations, which is what I was seeing in my problematic project.<p />I then changed the images XML to add a third image, and ran the test and got the following output:<p /><strong>Output</strong><p />Started at 11/08/2006 12:36:21<br />Image 8162_5260.JPG<br />For each logged at 11/08/2006 12:36:21 with data of Entry <br />Image 8162_5260_01.JPG<br />For each logged at 11/08/2006 12:36:21 with data of Entry<br />For each logged at 11/08/2006 12:36:21 with data of Entry<br />Image 100_1000.JPG<br />For each logged at 11/08/2006 12:36:22 with data of Entry<br />For each logged at 11/08/2006 12:36:22 with data of Entry <br />For each logged at 11/08/2006 12:36:22 with data of Entry<br />Completed at 11/08/2006 12:36:22<p />again implying that the data in the inner foreach contains both the current iteration, and any previous iterations.<p />I took a search on the <a href="http://forums.microsoft.com/MSDN/ShowForum.aspx?ForumID=80&amp;SiteID=1">MSDN SQL Server Integration Services</a> and found <a href="http://forums.microsoft.com/MSDN/ShowPost.aspx?PostID=198975&amp;SiteID=1">Nested Loops in the Control Flow</a> to be the closest to my issue.  Having to create a <a href="http://blogs.conchango.com/jamiethomson/archive/2005/05/16/1414.aspx">child package</a> sounds like a workaround rather than a solution to me but I figured it was worth a try and created a child package which just has the inner for each loop in it, and got the following output:<p /><strong>Output</strong><p />Started at 14/08/2006 15:38:47<br />Image 8162_5260.JPG<br />For each logged at 14/08/2006 15:38:48 with data of Entry<br />Image 8162_5260_01.JPG<br />For each logged at 14/08/2006 15:38:49 with data of Entry<br />Completed at 14/08/2006 15:38:49<p />So, finally it works as expected.  Now to go and integrate it into the main project rather than just this test one.</p>
