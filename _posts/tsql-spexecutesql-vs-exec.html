title: TSQL: sp_executesql vs exec
date: 2008/08/14 10:19:00 -0700
tags: [{"name":"SQLServer","id":3772644}]
author: Jane Dallaway
alias: /tsql-spexecutesql-vs-exec

There are 2 methods of executing dynamic SQL :<ul><li><a href="http://msdn.microsoft.com/en-us/library/aa258848(SQL.80).aspx">Exec</a> which executes a scalar-valued, user-defined function, a system procedure, a user-defined stored procedure, or an extended stored procedure</li><li><a href="http://msdn.microsoft.com/en-us/library/aa933299(SQL.80).aspx">sp_executesql</a> which executes a SQL statement or batch that can be reused many times, or that has been built dynamically</li></ul>Example SQL Statements - both returning the same results:<p /><ul><li><span class="code">Exec ('Select * from Items')</span></li><li><span class="code">DECLARE @strQuery AS NVARCHAR(50)<br />SET @strQuery = 'Select * from Items'<br />EXEC sp_executesql @strQuery</span></li></ul><br />As you can see sp_executesql demands a parameter to be sent rather than just a string.  This leads to improved security and improved performance because the SQL statement itself remains constant and only the parameter values change which means that the SQL Server query optimizer is likely to reuse the execution plan it generates for the first execution.<p />In addition, when writing a parameterized query, the additional parameters can be specified separately which again adds to the security, see the following which is based on the example on MSDN:<br /><span class="code">DECLARE @SQLString NVARCHAR(500)<br />DECLARE @ParmDefinition NVARCHAR(500)<br />DECLARE @TitleDefinition NVARCHAR(50) <p />/* Build the SQL string once.*/<br />SET @SQLString =N'SELECT * FROM ItemsWHERE Title like ''%'' + @title + ''%'''<br />SET @ParmDefinition = N'@title nvarchar(50)' <p />* Execute the string with the first parameter value. */ <br />SET @TitleDefinition = 'S'<br />EXECUTE sp_executesql @SQLString, @ParmDefinition, @title = @TitleDefinition <p />/* Execute the same string with the second parameter value. */<br />SET @TitleDefinition = 'P'<br />EXECUTE sp_executesql @SQLString, @ParmDefinition, @title = @TitleDefinition</span><p />So, if you have an option, use sp_executesql instead of exec<div class="blogger-post-footer"><img class="posterous_download_image" src="https://blogger.googleusercontent.com/tracker/14400377-549597067159507455?l=jane.dallaway.com%2Fblog%2Fblog.html" height="1" alt="" width="1" /></div>
