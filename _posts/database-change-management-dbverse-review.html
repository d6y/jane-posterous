title: Database change management: DBVerse review
date: 2008/04/25 06:09:00 -0700
tags: [{"name":"review","id":3772742},{"name":"SQLServer","id":58668982},{"name":"tool","id":58668987}]
author: Jane Dallaway
alias: /database-change-management-dbverse-review

<p>A few weeks ago I found a reference to <a href="http://code.google.com/p/dbverse/">DBVerse</a> in <a href="http://blog.cwa.me.uk/2008/03/25/the-morning-brew-58/">The Morning Brew #58</a> which seemed like a great starting point for a problem I've had time and time again - keeping databases in sync from a structure perspective making sure that all the dependencies are in place and there is little or no risk when running these changes into a live server.<p /><a href="http://bruceboughton.me.uk/">Bruce</a> and I spent an hour or so today looking into this tool as part of our <a href="http://madgex.com/">Madgex</a> <a href="http://jane.dallaway.com/tag/ilp">ILP</a> time, and the following are our observations.<p />DBVerse is a C# project, which you install as a template on your machine.  In my case, I copied the entire <a href="http://code.google.com/p/dbverse/downloads/list">DbVerseDatabaseProjectTemplate.zip</a> file, still as a zip, into my My Documents\Visual Studio 2005\Templates\ProjectTemplates folder.  <p />To add a new DBVerse project to a solution, it is pretty simple, just a case of Adding a new project of type DbVerse Database Project.  This will then create a new project, consisting of a DbVerse folder (which keeps all the required DLL and EXE files), a Scripts folder (in which any SQL scripts can be kept) and three cs files - Methods.cs, Methods.Initialize.cs and Methods.Updates.cs<p />The cs file we were most interested in was Methods.Updates.cs as that is our prime requirement - record and manage updates.  In DBVerse updates can be scripted as SQL and put into the Scripts folder and then executed via <br /><span class="code">Db.ExecuteScript("UpdateJaneTestTable.sql");</span> <br />or by using the DB objects that are exposed from the <span class="code">Lunaverse.DbVerse.Core</span> such as <span class="code">&nbsp;&nbsp;Db.AddTable("JaneTest");<br />&nbsp;&nbsp;Db.Table("JaneTest").AddColumn("ID", DataType.Int);<br />&nbsp;&nbsp;Db.Table("JaneTest").AddColumn("Name", DataType.NVarChar(255));</span>.  I'm a big believer in scripting out changes in SQL, as these can be tested against the database and written in a none destructive manner (i.e. checking for existance of an object before updating it etc).<p />Each update method is given an attribute similar to <br /><span class="code">[Update(2, "Jane Dallaway", "25/04/2008")]</span> <br />where 2 is the update number, "Jane Dallaway" is the author and "25/04/2008" is the date that the update was written.<p />The DBVerse project produces a dll, which is run via either a GUI or a console application.  To run the updates via the console application I ran <br /><span class="code">Lunaverse.DbVerse.Console.exe ApplyAllUpdates</span><p />A new table is created - Database Updates - which records all the updates scripts which have run, storing the ID, Method Name, Author, Authored data and Application Date.<p />On subsequent runs I expected this table to be checked before any updates were applied, and to test this I created the following Update<br /><span class="code"> [Update(3, "Jane Dallaway", "25/04/2008")]<br />&nbsp;&nbsp;public void InsertData()<br />&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;Db.ExecuteScript(("InsertData.sql"));<br />&nbsp;&nbsp;}</span><br />I commented out all previous Updates to make it easy to check and ran <br /><span class="code">Lunaverse.DbVerse.Console.exe ApplyAllUpdates</span><p />The output was <br /><span class="code">Starting...<br />------------------------------------------------------------<br /> Server=localhost  Database=JaneTest  Method count=-1<br />------------------------------------------------------------<br />Method starting [ApplyAllUpdates]<br />------------------------------------------------------------<br />Script [InsertData.sql] was run<br />Inserted row into table [DatabaseUpdates] ('InsertData', 'Jane Dallaway', '25/04/2008 00:00:00', '25/04/2008')<br />------------------------------------------------------------<br />Method finished [ApplyAllUpdates]<br />------------------------------------------------------------<br />Done: all methods completed<br />------------------------------------------------------------</span><br />When I checked the database I got the following output:<br /><span class="code">ID&nbsp;&nbsp;&nbsp;&nbsp;Name                                                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                    Description<br />1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Test&nbsp;&nbsp;&nbsp;&nbsp;                                                     &nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                         Test via DBVerse<p />(1 row(s) affected)</span><p />so all as I expected.<p />I then ran the console application again, and got the following output <br /><span class="code">Starting...<br />------------------------------------------------------------<br /> Server=localhost  Database=NewDesignPartners  Method count=-1<br />------------------------------------------------------------<br />Method starting [ApplyAllUpdates]<br />------------------------------------------------------------<br />Script [InsertData.sql] was run<br />------------------------------------------------------------<br />Method finished [ApplyAllUpdates]<br />------------------------------------------------------------<br />Done: all methods completed<br />------------------------------------------------------------</span><br />which has differing output to the previous time in the Script [InsertData.sql] line as last time we were notified what was inserted and this time we weren't.<br />On examining the database, the insert was run again resulting in the following rows<span class="code">ID&nbsp;&nbsp;&nbsp;&nbsp;Name&nbsp;&nbsp;&nbsp;&nbsp;                                                                             &nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                            Description<br />1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Test&nbsp;&nbsp;&nbsp;&nbsp;                                                     &nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                   Test via DBVerse<br />1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Test&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                                               Test via DBVerse<p />(2 row(s) affected)</span><p />This indicates that the check that the update hasn't already been run is causing an issue and cannot be relied upon.  This invalidates the tool for our use.  All of our other observations were minor - such as not being able to work out how to run all the updates in one go in the GUI, I could only seem to work out how to run one update at a time.<p />This project is a work in progress, and is probably worth keeping an eye on.  Maybe I'll revisit it at a later stage, but I think it might be time to write something that does exactly what we need for the <a href="http://www.madgex.com">Madgex</a> environment.</p>
