title: Double counting document downloads
date: 2008/01/22 03:33:00 -0800
tags: [{"name":".NET","id":3772781}]
author: Jane Dallaway
alias: /double-counting-document-downloads

One of the projects I'm working on counts document downloads.  Yesterday I was fixing a bug relating to it double counting, but only in IE.  The documents can only be pdf or docs.  We have .doc, .docx and .pdf files being handled by a DocumentHandler class as set up in web.config<br /><span class="code">&lt;httpHandlers&gt;<br />&lt;add verb="*" path="*.pdf" type="DocumentHandler"/&gt;<br />&lt;add verb="*" path="*.doc" type="DocumentHandler"/&gt;<br />&lt;add verb="*" path="*.docx" type="DocumentHandler"/&gt;<br />&lt;/httpHandlers&gt;</span><p />DocumentHandler has a ProcessRequest method.  Within this method we increment our count.<p />When opening a .pdf by either Firefox or IE this method gets called once.<br />When opening a .doc or .docx with Firefox this method gets called once.<br />When opening a .doc or .docx with IE this method gets called twice.  Firstly when the browser window is created, and then when the Open dialog is displayed.<p />I spent some time looking into this, especially concentrating on the differences within the context.Request object.  The second time this method is hit, the UserAgent is Microsoft Office Existence Discovery.  The other, more usable, difference is that Context.Request.UrlReferrer is null.  This is the condition I have chosen to use to prevent the double counting.  If someone stores the link to the document as a bookmark, then this won't count, but within the context of this application this is unlikely.<div class="blogger-post-footer"><img class="posterous_download_image" src="https://blogger.googleusercontent.com/tracker/14400377-6546396777954916603?l=jane.dallaway.com%2Fblog%2Fblog.html" height="1" alt="" width="1" /></div>
