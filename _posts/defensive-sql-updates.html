title: Defensive SQL Updates
date: 2008/03/26 02:37:00 -0700
tags: [{"name":"SQLServer","id":58678000}]
author: Jane Dallaway
alias: /defensive-sql-updates

One of my recent tasks, well before my month off anyway, was to upgrade a number of similar SQL Server 2005 databases to a new structure.  The databases had all started off the same, and were going to end up the same, but had been subjected to a differing number of bug fixes and enhancements along the way.<p />If I was updating just one database I would have used the excellent <a href="http://www.red-gate.com/products/SQL_Compare/index.htm">Redgate SQL Compare</a> (of which more in a future post) but as I had to update many then this would not have been the most reliable way.<p />Instead, I wrote defensive SQL, that is SQL which checks for impact before doing it.  So, before adding a column for instance, it checks to see if that column exists, and only attempts to add it if it doesn't - thus preventing errors.  The whole update script was wrapped in a Transaction, and by making use use of a variable <span class="code">@bError</span> of type <span class="code">BIT</span> to track any errors, the last statement could <span class="code">COMMIT</span> or <span class="code">ROLLBACK</span> the transaction as appropriate.<p />So, for example, to add a new column to a table, here is the script I used:<br /><span class="code">IF @bError = 0<br />BEGIN<br />&nbsp;&nbsp;IF NOT EXISTS (SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE Table_Name = 'MyTable' AND Column_Name = 'MyNewColumn')<br />&nbsp;&nbsp;BEGIN<p />&nbsp;&nbsp;&nbsp;&nbsp;ALTER TABLE MyTable ADD MyNewColumn INT NOT NULL<p /> &nbsp;&nbsp;&nbsp;&nbsp;IF NOT EXISTS (SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE Table_Name = 'MyTable' AND Column_Name = 'MyNewColumn')<br />&nbsp;&nbsp;&nbsp;&nbsp;BEGIN<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PRINT 'Error Adding column ColumnName to table MyTable'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SET @bError = 1<br />&nbsp;&nbsp;&nbsp;&nbsp;END<br />&nbsp;&nbsp;&nbsp;&nbsp;ELSE<br />&nbsp;&nbsp;&nbsp;&nbsp;BEGIN<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PRINT 'Added column ColumnName to table MyTable' <br />&nbsp;&nbsp;&nbsp;&nbsp;END<br />&nbsp;&nbsp;END<br />END</span><p />By checking for the column's existance after applying the change, I could determine if an error had occurred, and set the <span class="code">@bError</span> flag accordingly.  I used the Print statements to produce a log of exactly what stages had been carried out on each database, using the function <span class="code">DB_NAME()</span> to output the name of the current database at the beginning of the log.<div class="blogger-post-footer"><img class="posterous_download_image" src="https://blogger.googleusercontent.com/tracker/14400377-3062688644065155570?l=jane.dallaway.com%2Fblog%2Fblog.html" height="1" alt="" width="1" /></div>
