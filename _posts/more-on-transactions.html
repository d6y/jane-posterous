title: More on transactions
date: 2008/04/28 06:03:00 -0700
tags: [{"name":"SQLServer","id":58674736}]
author: Jane Dallaway
alias: /more-on-transactions

<p>After Friday's <a href="http://jane.dallaway.com/tsql-transactions-simple-nesting">experiment with transactions</a> in SQL Server I got to wondering about what would happen to actions between the<br />&nbsp;&nbsp;<span class="code">ROLLBACK TRAN</span><br />and the<br />&nbsp;&nbsp;<span class="code">IF @@TRANCOUNT &gt; 0<br />&nbsp;&nbsp;&nbsp;&nbsp;COMMIT TRAN</span><br />so I amended the code to have an additional INSERT as follows (Note: I also changed the final <span class="code">COMMIT TRAN</span> to be a <span class="code">ROLLBACK TRAN</span> to help show the differenence)<p /><span class="code">&nbsp;&nbsp;BEGIN TRAN<br />&nbsp;&nbsp;INSERT INTO COUNT VALUES (1)<br />&nbsp;&nbsp;&nbsp;&nbsp;BEGIN TRAN<br />&nbsp;&nbsp;&nbsp;&nbsp;INSERT INTO COUNT VALUES (4)<br />&nbsp;&nbsp;&nbsp;&nbsp;ROLLBACK TRAN<br />&nbsp;&nbsp;INSERT INTO COUNT VALUES (99) -- New line<br />&nbsp;&nbsp;IF @@TRANCOUNT &gt; 0<br />&nbsp;&nbsp;&nbsp;&nbsp;ROLLBACK TRAN</span><p />which results in the value 99 being inserted into the table, outside of the scope of any transactions - all transactions were rolled back in the inner <span class="code">ROLLBACK TRAN</span><p />To ensure that the second part of the statement, which might be unrelated to the first and therefore not dependent on the result of that transaction, is within a transaction, the following seems to work with the expected results:<p />&nbsp;&nbsp;<span class="code">BEGIN TRAN<br />&nbsp;&nbsp;INSERT INTO COUNT VALUES (1)<br />&nbsp;&nbsp;&nbsp;&nbsp;BEGIN TRAN<br />&nbsp;&nbsp;&nbsp;&nbsp;INSERT INTO COUNT VALUES (4)<br />&nbsp;&nbsp;ROLLBACK TRAN<p />&nbsp;&nbsp;IF @@TRANCOUNT = 0<br />&nbsp;&nbsp;&nbsp;&nbsp;BEGIN TRAN<br />&nbsp;&nbsp;&nbsp;&nbsp;INSERT INTO COUNT VALUES (99)<br />&nbsp;&nbsp;IF @@TRANCOUNT &gt; 0<br />&nbsp;&nbsp;&nbsp;&nbsp;ROLLBACK TRAN</span><p />No new row is added as a result of this action as now all actions are covered within a transaction.</p>
