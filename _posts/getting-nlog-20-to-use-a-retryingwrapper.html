title: Getting nLog 2.0 to use a RetryingWrapper
date: 2012/09/27 04:58:00 -0700
tags: [{"name":"Development","id":119925815},{"name":"nts","id":119925816}]
author: Jane Dallaway
alias: /getting-nlog-20-to-use-a-retryingwrapper

<p>I've been using <a href="http://nlog-project.org">nLog</a> within the delivery stack at work since I started automating the processes a few months ago. It works well the majority of the time, and I've got it logging usage stats as well as errors/debug information making use of the targetting to be able to direct different levels of issues to different logs. When a serious error occurs, then it emails to let me know. Unless we've had a network outage, in which case the email goes missing. Which isn't great.</p>
<p>I want to get it to retry until it suceeds ideally. But I found the documentation on using a RetryWrapper a bit sketchy. Consequently, I'm writing up my findings for myself. (Hence filed under <a href="http://jane.dallaway.com/tag/nts">nts</a>).</p>
<p>I first of all found <a href="http://nlog-project.org/wiki/RetryingWrapper_target">this</a>&nbsp;which I used as a base for my targets section:</p>
<p><span style="font-family: Consolas, Courier New;">&lt;targets&gt;</span><br /><span style="font-family: Consolas, Courier New;">&nbsp;&nbsp;&lt;target&nbsp;xsi:type="RetryingWrapper"&nbsp;name="<em>String</em>"&nbsp;retryDelayMilliseconds="<em>Integer</em>"&nbsp;retryCount="<em>Integer</em>"&gt;<br /><span style="font-family: Consolas, Courier New;">&nbsp;&nbsp;&nbsp;&nbsp;&lt;target xsi:type="wrappedTargetType" ...target properties... /&gt;</span><br /><span style="font-family: Consolas, Courier New;">&nbsp;&nbsp;&lt;/target&gt;</span><br /><span style="font-family: Consolas, Courier New;">&lt;/targets&gt;</span></span></p>
<p>I found it difficult to determine which parts of this should be replaced and which shouldn't. For instance the xsi:type="wrappedTargetType" bit should, perhaps obviously, be replaced with the actual type, i.e. xsi:type="File" or xsi:type="Mail". If you try and run it using&nbsp;xsi:type="wrappedTargetType" you'll get a "Target cannot be found: 'wrappedTargetType'" error message.</p>
<p>I decided that rather than starting to update the config for my applications, I'd start simply, so created a new solution and used the <a href="http://nlog-project.org/wiki/Tutorial">sample tutorial code</a> to exercise nLog. I got a simple version working as follows (with a lot of help from <a href="https://github.com/jkowalski/NLog/blob/master/examples/targets/Configuration%20File/RetryingWrapper/NLog.config">the worked example</a>.&nbsp; It's worth noting that there are a lot of <a href="https://github.com/jkowalski/NLog/tree/master/examples/targets/Configuration%20File">simple example configs available</a>):</p>
<p><span style="font-family: Consolas, Courier New;">&lt;targets&gt;<br /> &nbsp; &lt;target xsi:type="RetryingWrapper" name="errorLog" retryCount="5" retryDelayMilliseconds="5000" &gt;</span><br /><span style="font-family: Consolas, Courier New;"> &nbsp; &nbsp; &lt;target xsi:type="file" fileName="C:\Logs\${date:format=yyyy-MM-dd}.log" &nbsp;/&gt;&nbsp; &nbsp; &nbsp; &nbsp;</span><br /><span style="font-family: Consolas, Courier New;"> &nbsp; &lt;/target&gt;<br /><span style="font-family: Consolas, Courier New;"> &lt;/targets&gt;</span><br /><span style="font-family: Consolas, Courier New;"> &lt;rules&gt;</span><br /><span style="font-family: Consolas, Courier New;"> &nbsp; &lt;logger name="*" minlevel="Error" writeTo="errorLog" /&gt;</span><br /><span style="font-family: Consolas, Courier New;"> &lt;/rules&gt;</span></span></p>
<p>I recommend setting internal logging on whilst debugging/configuring nLog. The nLog section of my config file currently looks like:</p>
<p><span style="font-family: Consolas, Courier New;">&lt;nlog xmlns="http://www.nlog-project.org/schemas/NLog.xsd"</span><br /><span style="font-family: Consolas, Courier New;">&nbsp; &nbsp;&nbsp; &nbsp;xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"</span><br /><span style="font-family: Consolas, Courier New;">&nbsp; &nbsp; &nbsp; &nbsp;internalLogFile="C:\logs\nLogInternals.txt"<br /><span style="font-family: Consolas, Courier New;">&nbsp; &nbsp; &nbsp; &nbsp;internalLogLevel="Debug"&nbsp;<span style="font-family: Consolas, Courier New;">&gt;</span></span></span></p>
<p>which means it's writing all it's settings to the nLogInternals.txt file, which allows me to check that retry functionality is being set up in a manner I'd expect. Obviously this needs to be removed before deploying for real otherwise it'll end up creating huge log files all over the place.</p>
<p>During my research I'd also stumbled across the concept of <a href="http://nlog-project.org/wiki/Configuration_File#Default_wrappers">default-wrappers</a> (via <a href="http://stackoverflow.com/a/4098047/160307">this excellent stackoverflow answer</a>) which seemed to be what I wanted but I couldn't work out how to use them initially - possibly because I first attempted to plug it in to my more complicated, real, configuration. I don't want to change the retry information on a target by target basis. so by using a default-wrapper of type&nbsp;RetryingWrapper I seem to be able to wrap all of the targets within a RetryingWrapper in the same way as if I explicitly specified it (or at least that's what both my nLogInternals.txt file and the <a href="http://nlog-project.org/wiki/Configuration_File#Default_wrappers">documentation</a> both seem to suggest).</p>
<p>So, my (simplified) final solution looks like the following:</p>
<p><span style="font-family: Consolas, Courier New;">&lt;targets&gt;</span><br /> <span style="font-family: Consolas, Courier New;">&nbsp; &nbsp; &nbsp; &lt;default-wrapper xsi:type="RetryingWrapper" retryCount="5" retryDelayMilliseconds="5000" /&gt; &nbsp; &nbsp; &nbsp;</span><br /> <span style="font-family: Consolas, Courier New;">&nbsp; &nbsp; &nbsp; &lt;target xsi:type="file" fileName="C:\Logs\${date:format=yyyy-MM-dd}.log" name="errorLog" /&gt;</span><br /> <span style="font-family: Consolas, Courier New;">&nbsp; &nbsp; &nbsp; &lt;target xsi:type="file" fileName="C:\Logs\FATAL-${date:format=yyyy-MM-dd}.log" name="fatalLog" /&gt;</span><br /> <span style="font-family: Consolas, Courier New;">&nbsp; &nbsp; &lt;/targets&gt;</span><br /> <span style="font-family: Consolas, Courier New;">&nbsp;</span><br /> <span style="font-family: Consolas, Courier New;">&nbsp; &nbsp; &lt;rules&gt;</span><br /> <span style="font-family: Consolas, Courier New;">&nbsp; &nbsp; &nbsp; &lt;logger name="*" minlevel="Warn" writeTo="errorLog" /&gt;</span><br /> <span style="font-family: Consolas, Courier New;">&nbsp; &nbsp; &nbsp; &lt;logger name="*" minlevel="Fatal" writeTo="fatalLog" /&gt;</span><br /> <span style="font-family: Consolas, Courier New;">&nbsp; &nbsp; &lt;/rules&gt;</span></p>
<p>which seems to do what I think it should. Now to update all the applications in my stack to use these settings.</p>
