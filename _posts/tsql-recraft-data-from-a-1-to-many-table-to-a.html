title: TSQL: Recraft data from a 1 to many table to a 1 to 1 table preserving a single row of data
date: 2009/09/14 09:53:00 -0700
tags: [{"name":"code","id":58678472},{"name":"SQLServer","id":3772486}]
author: Jane Dallaway
alias: /tsql-recraft-data-from-a-1-to-many-table-to-a

A colleague asked me to help with a SQL deletion today, and it took us both a while to work out a way to do it.  As it was a one off item, we did it using temporary tables, but I figured I'd try and find out a better way of doing this.<p />The problem:<br />A table has been created which is a 1 to many relation table, but the business logic has now changed, and this is now a 1 to 1 relationship.  So, we need to remove the excess rows to make the data comply with the new rule.  In each case, we are going to keep the row with the lowest Child Item Id and delete the others.<p />The table is defined as:<br /><span class="code">CREATE TABLE [dbo].[Mapping]<br />(<br />&nbsp;&nbsp;[ParentId] [int] NOT NULL,<br />&nbsp;&nbsp;[ChildId] [int] NOT NULL<br />)</span><p />The data is populated as:<br /><span class="code">INSERT INTO [Mapping] ([ParentId], [ChildId])VALUES (1,1)<br />INSERT INTO [Mapping] ([ParentId], [ChildId])VALUES (1,3)<br />INSERT INTO [Mapping] ([ParentId], [ChildId])VALUES (2,1)<br />INSERT INTO [Mapping] ([ParentId], [ChildId])VALUES (2,4)<br />INSERT INTO [Mapping] ([ParentId], [ChildId])VALUES (1,5)<br />INSERT INTO [Mapping] ([ParentId], [ChildId])VALUES (3,1)</span><p />At the end of the deletion, the data present should be:<br /><span class="code">ParentId&nbsp;&nbsp;ChildId<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1</span><p />What I needed to do was get a list of the items to keep, this was pretty simple<br /><span class="code">SELECT ParentId, MIN(ChildId) ChildId<br />FROM Mapping<br />GROUP BY ParentId</span><br />which produced a list which matched the data I wanted to keep.  Next I wanted to get a list of the items to delete.  To do this, I made use of the <a href="http://msdn.microsoft.com/en-us/library/ms188055.aspx">EXCEPT</a> keyword, and set theory, to return me everything that was left when I'd taken my data to keep away from the total amount of data, or in SQL<br /><span class="code">SELECT ParentId, ChildId <br />FROM Mapping <br />EXCEPT<br />SELECT ParentId, MIN(ChildId) ChildId<br />FROM Mapping<br />GROUP BY ParentId</span><p />This produced the data I needed to delete.<br />Then all I needed to do was DELETE it.  What I wanted to do was join the original table to the results of my set and delete them.  But every time I've tried to delete based on a join I've had the following error<br /><span class="code">Msg 102, Level 15, State 1, Line 2<br />Incorrect syntax near 'm'.<br />Msg 102, Level 15, State 1, Line 9<br />Incorrect syntax near 'i'.</span><br />and given up.  Today, I went and read the <a href="http://msdn.microsoft.com/en-us/library/aa258847(SQL.80).aspx">documentation</a>, and discovered that it was possible, but I had to specify the tablename immediately after the DELETE keyword, i.e.<br /><span class="code">DELETE FROM Mapping<br />FROM Mapping m<br />INNER JOIN<br />(SELECT ParentId, ChildId <br />FROM Mapping <br />EXCEPT<br />SELECT ParentId, MIN(ChildId) ChildId<br />FROM Mapping<br />GROUP BY ParentId) i<br />ON m.ParentId = i.ParentId<br />AND m.ChildId = i.ChildId</span><p />That works, and leaves me with the correct data in the table, but looks rather odd...<div class="blogger-post-footer"><img class="posterous_download_image" src="https://blogger.googleusercontent.com/tracker/14400377-5157368611511393913?l=jane.dallaway.com%2Fblog%2Fblog.html" height="1" alt="" width="1" /></div>
