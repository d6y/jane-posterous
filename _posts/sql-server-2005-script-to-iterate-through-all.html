title: SQL Server 2005 script to iterate through all the databases on a server
date: 2009/08/17 12:50:00 -0700
tags: [{"name":"code","id":58678484},{"name":"SQLServer","id":58646295}]
author: Jane Dallaway
alias: /sql-server-2005-script-to-iterate-through-all

A few of the SQL Server 2005 helper scripts/maintenance scripts I've written recently have taken the form of <ul><li>produce a SQL script</li><li>run it on all appropriate databases</li><li>display the output</li></ul>To do this, I've adapted the following SQL to run the query I want, sometimes inserting data into a temporary table/table variable for later retrieval, and sometimes just selecting the results.  The following example is checking each user database for a table called ErrorLog, and if there is one selecting the data from it, prefixing the results with a column identifying the server name (using <a href="http://msdn.microsoft.com/en-us/library/aa933172(SQL.80).aspx">@@SERVERNAME</a> - this is because I've been running these scripts across many servers and manually concatenating the results) and the database name (using our local variable @DBName), and also printing any errors to the output window<p /><span class="code">DECLARE @Loop int<br />DECLARE @DBName varchar(300)<br />DECLARE @SQL varchar(max)<br />DECLARE @tableName VARCHAR(255)<p />SET @Loop = 1<br />SET @DBName = ''<p />&nbsp;&nbsp;&nbsp;WHILE @Loop = 1<br />BEGIN<p />&nbsp;&nbsp;&nbsp;SELECT TOP 1 @DBName = d.Name<br />&nbsp;&nbsp;&nbsp;FROM master.sys.databases d<br />&nbsp;&nbsp;&nbsp;WHERE d.Name > @DBName<br />&nbsp;&nbsp;&nbsp;AND d.database_id not in (1, 2, 3, 4)<br />&nbsp;&nbsp;&nbsp;ORDER BY d.Name<p />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SET @Loop = @@ROWCOUNT<p />&nbsp;&nbsp;&nbsp;IF @Loop = 0 <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BREAK<p />&nbsp;&nbsp;&nbsp;SET @SQL = <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'IF EXISTS (SELECT 1 FROM [' + @DBName + '].sys.objects WHERE [name] = ''ErrorLog'') <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BEGIN<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SELECT ''' + @@SERVERNAME + ''', ''' + @DBName + ''', ErrorMessage, ErrorDate <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM [' + @DBName + '].dbo.ErrorLog <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;END <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ELSE <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BEGIN <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PRINT ''ErrorLog table does not exist on server: ' + @@SERVERNAME + ' and database: ' + @DBName + ''' <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;END ' <p />&nbsp;&nbsp;&nbsp;BEGIN TRY<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EXEC master.dbo.sp_executeSQL @SQL<br />&nbsp;&nbsp;&nbsp;END TRY<br />&nbsp;&nbsp;&nbsp;BEGIN CATCH<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PRINT 'Error executing ' + @SQL + ' on server: ' + @@SERVERNAME + ' for database: ' + @DBName<br />&nbsp;&nbsp;&nbsp;END CATCH<br />END</span><div class="blogger-post-footer"><img class="posterous_download_image" src="https://blogger.googleusercontent.com/tracker/14400377-8152992055872879831?l=jane.dallaway.com%2Fblog%2Fblog.html" height="1" alt="" width="1" /></div>
